// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String   @id @default(uuid()) @db.Uuid
  email           String   @unique @db.VarChar(255)
  name            String?  @db.VarChar(255)
  timezone        String   @default("UTC") @db.VarChar(50)
  bedtimeReminder DateTime? @map("bedtime_reminder") @db.Time
  morningReminder DateTime? @map("morning_reminder") @db.Time
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at")

  domains         Domain[]
  dailyJournals   DailyJournal[]
  visionBoards    VisionBoard[]
  boardDesigns    BoardDesign[]
  timelineSnapshots TimelineSnapshot[]
  reminders       Reminder[]

  @@map("users")
}

model Domain {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  name        String   @db.VarChar(100)
  description String?  @db.Text
  colorHex    String?  @map("color_hex") @db.VarChar(7)
  sortOrder   Int?     @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  images      DomainImage[]
  goals       Goal[]
  todos       Todo[]
  pixelHistory PixelHistory[]

  @@map("domains")
}

model DomainImage {
  id          String   @id @default(uuid()) @db.Uuid
  domainId    String   @map("domain_id") @db.Uuid
  imageUrl    String   @map("image_url") @db.Text
  sortOrder   Int?     @map("sort_order")
  uploadedAt  DateTime @default(now()) @map("uploaded_at")

  domain      Domain   @relation(fields: [domainId], references: [id], onDelete: Cascade)

  @@map("domain_images")
}

model Goal {
  id            String   @id @default(uuid()) @db.Uuid
  domainId      String   @map("domain_id") @db.Uuid
  title         String   @db.Text
  description   String?  @db.Text
  status        String   @default("active") @db.VarChar(20) // active, archived, completed
  startDate     DateTime @map("start_date") @db.Date
  targetDate    DateTime? @map("target_date") @db.Date
  archivedAt    DateTime? @map("archived_at")
  archiveReason String?  @map("archive_reason") @db.Text
  parentGoalId  String?  @map("parent_goal_id") @db.Uuid
  createdAt     DateTime @default(now()) @map("created_at")

  domain        Domain   @relation(fields: [domainId], references: [id], onDelete: Cascade)
  parentGoal    Goal?    @relation("GoalTransitions", fields: [parentGoalId], references: [id])
  childGoals    Goal[]   @relation("GoalTransitions")
  milestones    Milestone[]
  todos         Todo[]

  @@map("goals")
}

model Milestone {
  id          String   @id @default(uuid()) @db.Uuid
  goalId      String   @map("goal_id") @db.Uuid
  title       String   @db.Text
  targetDate  DateTime? @map("target_date") @db.Date
  completedAt DateTime? @map("completed_at")
  sortOrder   Int?     @map("sort_order")

  goal        Goal     @relation(fields: [goalId], references: [id], onDelete: Cascade)
  todos       Todo[]

  @@map("milestones")
}

model Todo {
  id            String   @id @default(uuid()) @db.Uuid
  milestoneId   String?  @map("milestone_id") @db.Uuid
  goalId        String   @map("goal_id") @db.Uuid
  domainId      String   @map("domain_id") @db.Uuid
  title         String   @db.Text
  description   String?  @db.Text
  scheduledDate DateTime? @map("scheduled_date") @db.Date
  status        String   @default("pending") @db.VarChar(20) // pending, approved, completed, skipped
  approvedAt    DateTime? @map("approved_at")
  completedAt   DateTime? @map("completed_at")
  effortWeight  Decimal? @default(1.0) @map("effort_weight") @db.Decimal(3, 2)
  createdAt     DateTime @default(now()) @map("created_at")

  milestone     Milestone? @relation(fields: [milestoneId], references: [id], onDelete: Cascade)
  goal          Goal      @relation(fields: [goalId], references: [id], onDelete: Cascade)
  domain        Domain    @relation(fields: [domainId], references: [id], onDelete: Cascade)
  journalCompletions JournalTaskCompletion[]

  @@map("todos")
}

model DailyJournal {
  id             String   @id @default(uuid()) @db.Uuid
  userId         String   @map("user_id") @db.Uuid
  journalDate    DateTime @map("journal_date") @db.Date
  entryText      String?  @map("entry_text") @db.Text
  emotionalState String?  @map("emotional_state") @db.VarChar(50)
  energyLevel    Int?     @map("energy_level")
  aiReflection   String?  @map("ai_reflection") @db.Text
  submittedAt    DateTime @default(now()) @map("submitted_at")

  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  taskCompletions JournalTaskCompletion[]
  pixelHistory   PixelHistory[]

  @@unique([userId, journalDate])
  @@map("daily_journals")
}

model JournalTaskCompletion {
  id        String   @id @default(uuid()) @db.Uuid
  journalId String   @map("journal_id") @db.Uuid
  todoId    String   @map("todo_id") @db.Uuid
  completed Boolean? @default(true)
  notes     String?  @db.Text

  journal   DailyJournal @relation(fields: [journalId], references: [id], onDelete: Cascade)
  todo      Todo         @relation(fields: [todoId], references: [id], onDelete: Cascade)

  @@map("journal_task_completions")
}

model VisionBoard {
  id             String   @id @default(uuid()) @db.Uuid
  userId         String   @map("user_id") @db.Uuid
  boardType      String   @map("board_type") @db.VarChar(20) // annual, quarterly, monthly, weekly
  periodStart    DateTime @map("period_start") @db.Date
  periodEnd      DateTime @map("period_end") @db.Date
  designStyle    String?  @map("design_style") @db.VarChar(50)
  layoutMetadata Json?    @map("layout_metadata")
  baseImageUrl   String?  @map("base_image_url") @db.Text
  currentImageUrl String? @map("current_image_url") @db.Text
  totalPixels    Int?     @map("total_pixels")
  coloredPixels  Int?     @default(0) @map("colored_pixels")
  createdAt      DateTime @default(now()) @map("created_at")
  lastUpdated    DateTime @default(now()) @map("last_updated")

  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  pixelHistory   PixelHistory[]

  @@map("vision_boards")
}

model PixelHistory {
  id             String   @id @default(uuid()) @db.Uuid
  visionBoardId  String?  @map("vision_board_id") @db.Uuid
  domainId       String?  @map("domain_id") @db.Uuid
  journalId      String?  @map("journal_id") @db.Uuid
  pixelsEarned   Int      @map("pixels_earned")
  pixelCoordinates Json?  @map("pixel_coordinates")
  earnedAt       DateTime @default(now()) @map("earned_at")
  immutable      Boolean? @default(false)

  visionBoard    VisionBoard? @relation(fields: [visionBoardId], references: [id], onDelete: Cascade)
  domain         Domain?      @relation(fields: [domainId], references: [id], onDelete: Cascade)
  journal        DailyJournal? @relation(fields: [journalId], references: [id], onDelete: Cascade)

  @@map("pixel_history")
}

model BoardDesign {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String   @map("user_id") @db.Uuid
  designName      String?  @map("design_name") @db.VarChar(100)
  designStyle     String?  @map("design_style") @db.VarChar(50)
  layoutAlgorithm String?  @map("layout_algorithm") @db.VarChar(50)
  previewUrl      String?  @map("preview_url") @db.Text
  isActive        Boolean? @default(false) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("board_designs")
}

model TimelineSnapshot {
  id            String   @id @default(uuid()) @db.Uuid
  userId        String   @map("user_id") @db.Uuid
  snapshotDate  DateTime @map("snapshot_date") @db.Date
  snapshotType  String?  @map("snapshot_type") @db.VarChar(20)
  boardImageUrl String?  @map("board_image_url") @db.Text
  narrativeText String?  @map("narrative_text") @db.Text
  animationUrl  String?  @map("animation_url") @db.Text
  createdAt     DateTime @default(now()) @map("created_at")

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("timeline_snapshots")
}

model Reminder {
  id            String   @id @default(uuid()) @db.Uuid
  userId        String   @map("user_id") @db.Uuid
  reminderType  String?  @map("reminder_type") @db.VarChar(50)
  scheduledTime DateTime @map("scheduled_time") @db.Time
  lastSent      DateTime? @map("last_sent")
  enabled       Boolean? @default(true)

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("reminders")
}
